# -*- coding: utf-8 -*-
"""
/***************************************************************************
 imageLoaderDockWidget
                                 A QGIS plugin
 Loads and unloads images.
 Generated by Plugin Builder: http://g-sherman.github.io/Qgis-Plugin-Builder/
                             -------------------
        begin                : 2022-03-24
        git sha              : $Format:%H$
        copyright            : (C) 2022 by Drew
        email                : drew.bennett@ptsinternational.co.uk
 ***************************************************************************/

/***************************************************************************
 *                                                                         *
 *   This program is free software; you can redistribute it and/or modify  *
 *   it under the terms of the GNU General Public License as published by  *
 *   the Free Software Foundation; either version 2 of the License, or     *
 *   (at your option) any later version.                                   *
 *                                                                         *
 ***************************************************************************/
"""

import os

from qgis.PyQt import QtWidgets, uic
from qgis.PyQt.QtCore import pyqtSignal,QUrl#,Qt
from qgis.utils import iface
from qgis.core import Qgis


from .functions.load_frame_data import loadFrameData
from .functions.load_cracking import loadCracking
from .widgets import set_layers_dialog

from PyQt5.QtWidgets import QMenuBar,QFileDialog#,QDataWidgetMapper
from PyQt5 import QtGui


from image_loader.image_model import imageModel
from image_loader.corrections_model import correctionsModel



#from PyQt5.QtCore import QModelIndex
#from PyQt5.QtCore import QSortFilterProxyModel



#from image_loader import test########################
#import cProfile


#from image_loader import details_tree_model
from image_loader.load_gps import loadGpsLines



FORM_CLASS, _ = uic.loadUiType(os.path.join(
    os.path.dirname(__file__), 'image_loader_dockwidget_base.ui'))

from image_loader import db_functions

class imageLoaderDockWidget(QtWidgets.QDockWidget, FORM_CLASS):

    closingPlugin = pyqtSignal()

    def __init__(self, parent=None):        
        super(imageLoaderDockWidget, self).__init__(parent)
        self.setupUi(self)
        self.layersDialog = set_layers_dialog.setLayersDialog(parent=self)

       # self.correctionsDialog = correctionsDialog()
     #   self.correctionsButton.clicked.connect(self.correctionsDialog.show)#need non modal to click map
        
      
        db_functions.createDb(file = r'C:\Users\drew.bennett\AppData\Roaming\QGIS\QGIS3\profiles\default\python\plugins\image_loader\images.db')
        self.model = imageModel(parent=self)
        self.model.fields = self.layersDialog
        self.initTopMenu()

        self.correctionsModel = correctionsModel()
        self.correctionsView.setModel(self.correctionsModel)
        
        
       # self.loadButton.clicked.connect(self.loadImages)
      #  self.remakeButton.clicked.connect(self.remakeImages)
        
        
    #    self.mapper = QDataWidgetMapper()
    ##    self.mapper.setModel(self.model)
     #   self.mapper.addMapping(self.chainageCorrection, details_tree_model.cols.chainageCorrection)
      #  self.mapper.addMapping(self.offset, details_tree_model.cols.offsetCorrection)   
                
        self.runBox.setModel(self.model.runsModel)
 

        self.imagesView.setModel(self.model)
       # self.setFile()

        self.runBox.currentIndexChanged.connect(self.runChange)
        self.addCorrectionButton.clicked.connect(self.addCorrection)



    def addCorrection(self):
        self.correctionsModel.addCorrections([{'run' : self.runBox.itemText(self.runBox.currentIndex()),
                                 'original_chainage' : self.startChainage.value(),
                                 'new_chainage' : self.endChainage.value(),
                                 'original_offset' : self.startOffset.value(),
                                 'new_offset' : self.endOffset.value()}])



    def loadImages(self):
        self.model.loadImages(self.imagesView.selected())
        
    
   
    def georeferenceImages(self):
        if self.model.hasGps():
            self.model.georeference()
        else:
            iface.messageBar().pushMessage("Image_loader", "GPS data required", level=Qgis.Info)
        
        
    def runChange(self):
        index = self.runBox.currentIndex()#int
        run = self.runBox.itemText(index)
        self.model.setRun(run)
        self.correctionsModel.setRun(run)
        
    
    def new(self):
        self.model.clear()
        self.correctionsModel.clear()


    def initTopMenu(self):
        topMenu = QMenuBar(self.mainWidget)    
        
        fileMenu = topMenu.addMenu("File")
        newAct = fileMenu.addAction('New')
        newAct.triggered.connect(self.new)
        
        openAct = fileMenu.addAction('Open...')
        openAct.triggered.connect(self.openFile)
        
        saveAsAct = fileMenu.addAction('Save as...')
        saveAsAct.triggered.connect(self.saveAs)
        
        openAct = fileMenu.addAction('Open corrections...')
        openAct.triggered.connect(self.openCorrections)
        
        
        
        ######################load
        toolsMenu = topMenu.addMenu("Tools")
        fromFolderAct = toolsMenu.addAction('Find details from folder...')
        fromFolderAct.triggered.connect(self.detailsFromFolder)

        #layersMenu = topMenu.addMenu("Load layers")
        loadFramesAct = toolsMenu.addAction('View Spatial Frame Data...')
        loadFramesAct.triggered.connect(self.loadFrames)
        
        loadGpsAct = toolsMenu.addAction('View GPS data...')
        loadGpsAct.triggered.connect(self.viewGpsLayer)
        
      #  chainageAct = toolsMenu.addAction('Find chainage difference...')
       # chainageAct.triggered.connect(self.chainageDialog.exec_)
        
        setupMenu = topMenu.addMenu("Setup")
        setLayers = setupMenu.addAction('Set layers and fields...')
        setLayers.triggered.connect(self.layersDialog.exec_)
        
        loadGpsAct = setupMenu.addAction('Load gps...')
        loadGpsAct.triggered.connect(self.loadGps)
        
        
        loadCracksAct = toolsMenu.addAction('View Cracking Data...')
        loadCracksAct.triggered.connect(self.loadCracks)        
        
        
        selectMenu = topMenu.addMenu("Select")
        markAllAct = selectMenu.addAction('Mark all images')
        markAllAct.triggered.connect(self.model.markAll)

        unmarkAllAct = selectMenu.addAction('Unmark all images')
        unmarkAllAct.triggered.connect(self.model.unmarkAll)
         
        processMenu = topMenu.addMenu("Process")
        
        loadAct = processMenu.addAction('Load selected images')
        loadAct.triggered.connect(self.loadImages)
        
        georeferenceAct = processMenu.addAction('Georeference selected images')
        georeferenceAct.triggered.connect(self.georeferenceImages)
        
        vrtAct = processMenu.addAction('Make combined VRTs for selected images')
        vrtAct.triggered.connect(self.makeVrt)
        
        
        helpMenu = topMenu.addMenu('Help')
        openHelpAct = helpMenu.addAction('Open help (in your default web browser)')
        openHelpAct.triggered.connect(self.openHelp)        
        self.mainWidget.layout().setMenuBar(topMenu)



    def framesLayer(self):
        return self.layersDialog.framesLayer()

    def idField(self):
        return self.layersDialog.idField()
  
    def runField(self):
        return self.layersDialog.runField()
    

#opens help/index.html in default browser
    def openHelp(self):
        helpPath = os.path.join(os.path.dirname(__file__),'help','help.html')
        helpPath = 'file:///'+os.path.abspath(helpPath)
        QtGui.QDesktopServices.openUrl(QUrl(helpPath))

        

    def loadFrames(self):
        f = QFileDialog.getOpenFileName(caption = 'Load Spatial Frame Data',filter = 'txt (*.txt)')
        if f:
            if f[0]:
                loadFrameData(f[0])



    def viewGpsLayer(self):
        f = QFileDialog.getOpenFileName(caption = 'Load GPS Data',filter = 'csv (*.csv)')
        if f:
            if f[0]:
                loadGpsLines(f[0])


    def makeVrt(self):
        self.model.makeVrt()

    def loadGps(self):
        
        p = os.path.join(self.layersDialog['folder'],'Hawkeye Exported Data')
        if os.path.isdir(p):
            d = p
        else:
            d = ''
        
        f = QFileDialog.getOpenFileName(caption = 'Load GPS Data',filter = 'csv (*.csv)',directory=d)
        if f:
            if f[0]:
                self.model.loadGps(f[0])

    def loadCracks(self):
        f = QFileDialog.getOpenFileName(caption = 'Load Crack data Data',filter = 'txt (*.txt)')
        if f:
            if f[0]:
                loadCracking(f[0])
                

    #open dialog and load csv/sqlite file
    def openFile(self):
        f = QFileDialog.getOpenFileName(caption = 'open',filter = '*;;*.csv;;*.txt')[0]
        if f:
           # self.setFile(f)
            self.model.loadFile(f)    
            
            
    def openCorrections(self):
        
        f = getFile(folder = os.path.join(self.layersDialog['folder'],'Processed Data') , filt = '*;;*.csv')
        
       # f = QFileDialog.getOpenFileName(caption = 'open',filter = '*;;*.csv')[0]
        if f:
            self.correctionsModel.loadFile(f)
        
        
            
    #could save to sqlite database. Would confuse users and no real advantages.
    def saveAs(self):
        f = QFileDialog.getSaveFileName(caption = 'Save details',filter = 'csv (*.csv);;txt (*.txt)')[0]
        if f:
            self.model.save(f)
            iface.messageBar().pushMessage("Image_loader", "Saved to csv", level=Qgis.Info)



    #load all tif files in folder and consider showing progress bar
    def detailsFromFolder(self):
        f = QFileDialog.getExistingDirectory(self,'Folder with images')
        if f:
           # progress = QProgressDialog("Finding image details...","Cancel",0,0,self)
         #   progress.setWindowModality(Qt.WindowModal)
            self.model.addFolder(f)
           # progress.deleteLater()
           
           

    def closeEvent(self, event):
        self.closingPlugin.emit()
        event.accept()





def getFile(folder,filt):
        if os.path.isdir(folder):
            d = folder
        else:
            d = ''
        f = QFileDialog.getOpenFileName(caption = 'Load GPS Data',filter = filt,directory=d)
        if f:
            return f[0]